<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Modulo</title>
  <link rel="stylesheet" href="../style/style.css">
  <style>
    #userInput {
      font-size: 28px;
      padding: 15px;
      width: 300px;
      text-align: center;
    }
    #feedback {
      margin-top: 15px;
      font-size: 20px;
    }
    #prompt {
      font-size: 50px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1 id="pageTitle">Caricamento...</h1>

  <div id="hintToggle" style="margin-bottom: 20px; display: none;">
    <label><input type="checkbox" id="hintCheckbox" checked> Mostra hint (lettura e significato)</label>
  </div>

  <div id="content">üì° Caricamento dati in corso...</div>

  <div id="exerciseArea" style="display: none;">
    <div id="prompt"></div>
    <input type="text" id="userInput" placeholder="Scrivi qui...">
    <button onclick="checkAnswer()">Verifica</button>
    <p id="feedback"></p>
  </div>

  <p id="error" style="color: red; margin-top: 20px;"></p>

  <script>
    const fileName = location.pathname.split('/').pop().split('.html')[0];
    const moduleName = decodeURIComponent(fileName);
    const params = new URLSearchParams(window.location.search);
    const type = params.get("type") || "Studio";
    const sheetId = "1rAWuzob8dLBdZ9hyg287wefYT57CqOoB6CAogz-HKFA";
    const sheetUrl = `https://opensheet.elk.sh/${sheetId}/${moduleName}`;
    const isKanaModule = ["Hiragana", "Katakana"].includes(moduleName);

    document.title = `${moduleName} ‚Äì ${type}`;
    document.getElementById("pageTitle").innerText = `${moduleName} ‚Äì ${type}`;

    let vocab = [];
    let current = null;
    let stage = "normal";
    let repeatCount = 0;
    let blindCount = 0;

    fetch(sheetUrl)
      .then(res => {
        if (!res.ok) throw new Error("Foglio non trovato o non pubblico.");
        return res.json();
      })
      .then(data => {
        vocab = data.map(row => ({
          kanji: row.Kanji || row.Kana || "",
          kana: row.Kana || "",
          hiragana: row.hiragana || "",
          romaji: row.romaji || "",
          meaning: row.significato || ""
        }));
        startModule();
      })
      .catch(err => {
        console.error(err);
        document.getElementById("error").innerText = `‚ùå Errore: ${err.message}`;
        setTimeout(() => window.location.href = "../index.html", 3000);
      });

    function startModule() {
      const hintToggle = document.getElementById("hintToggle");
      const content = document.getElementById("content");
      const exerciseArea = document.getElementById("exerciseArea");

      if (type === "Studio") {
        hintToggle.style.display = "none";
        exerciseArea.style.display = "none";
        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>Kanji / Kana</th>
              <th>Hiragana</th>
              <th>Romaji</th>
              <th>Significato</th>
            </tr>
          </thead>
          <tbody>
            ${vocab.map(r => `
              <tr>
                <td>${r.kanji}</td>
                <td>${r.hiragana || "-"}</td>
                <td>${r.romaji || "-"}</td>
                <td>${r.meaning || "-"}</td>
              </tr>
            `).join("")}
          </tbody>`;
        content.innerHTML = "";
        content.appendChild(table);
      } else {
        hintToggle.style.display = "block";
        content.innerHTML = "";
        exerciseArea.style.display = "block";
        nextWord();
      }
    }

    function nextWord() {
      current = vocab[Math.floor(Math.random() * vocab.length)];
      stage = "normal";
      repeatCount = 0;
      blindCount = 0;

      const prompt = document.getElementById("prompt");
      const feedback = document.getElementById("feedback");
      const input = document.getElementById("userInput");

      prompt.innerHTML = current.kanji;
      feedback.innerText = "";
      input.value = "";
      input.focus();
    }

    function checkAnswer() {
      const inputField = document.getElementById("userInput");
      const input = inputField.value.trim().toLowerCase();
      const feedback = document.getElementById("feedback");
      const showHints = document.getElementById("hintCheckbox").checked;

      const expected = isKanaModule ? current.romaji.toLowerCase() : current.hiragana;

      // Sempre cancella input
      inputField.value = "";
      inputField.focus();

      const solution = isKanaModule
        ? `${current.romaji} ‚Äì ${current.meaning}`
        : `${current.hiragana} ‚Äì ${current.meaning}`;

      if (stage === "normal") {
        if (input === expected) {
          feedback.innerHTML = `‚úÖ Corretto!<br><em>${solution}</em>`;
          setTimeout(nextWord, 1000);
        } else {
          feedback.innerHTML = `‚ùå Sbagliato!<br><em>${solution}</em>`;
          stage = "correction";
        }
      } else if (stage === "correction") {
        if (input === expected) {
          repeatCount++;
          feedback.innerHTML = `‚úçÔ∏è Ripeti ${3 - repeatCount}x con hint<br><em>${solution}</em>`;
          if (repeatCount >= 3) {
            stage = "blind";
          }
        } else {
          repeatCount = 0;
          feedback.innerHTML = `‚ùå Ancora sbagliato. Ricominciamo.<br><em>${solution}</em>`;
        }
      } else if (stage === "blind") {
        if (input === expected) {
          blindCount++;
          feedback.innerHTML = `üîÅ Corretta ${blindCount}/2 volte`;
          if (blindCount >= 2) {
            setTimeout(nextWord, 1000);
          }
        } else {
          stage = "correction";
          repeatCount = 0;
          feedback.innerHTML = `‚ùå Torniamo agli aiuti.<br><em>${solution}</em>`;
        }
      }
    }

    document.getElementById("userInput").addEventListener("keyup", function (e) {
      if (e.key === "Enter") checkAnswer();
    });
  </script>
</body>
</html>
